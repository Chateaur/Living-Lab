Imports System.Globalization

Public Class Form1
    Private Sub bt_open_fbd_Click(sender As Object, e As EventArgs) Handles bt_open_fbd.Click
        Dim fbd As New OpenFileDialog

        With fbd
            'On spécifie l'extension de fichiers visibles
            .Filter = "Fichiers texte (*.csv) | *.csv"
            'On affiche et teste le retour du dialogue
            If .ShowDialog = System.Windows.Forms.DialogResult.OK Then
                'On récupère le nom du fichier
                Me.txt_path.Text = .FileName
            End If
        End With
    End Sub

    Private Sub Button1_Click(sender As Object, e As EventArgs) Handles Button1.Click
        'On charge le fichier
        Dim TextFileReader As New Microsoft.VisualBasic.FileIO.TextFieldParser(Me.txt_path.Text)

        TextFileReader.TextFieldType = FileIO.FieldType.Delimited
        TextFileReader.SetDelimiters(";")

        Dim TextFileTable As DataTable = Nothing

        Dim Column As DataColumn
        Dim Row As DataRow
        Dim UpperBound As Int32
        Dim ColumnCount As Int32
        Dim CurrentRow As String()
        Dim DateTemp As Date
        Dim DoubleTemp As Double

        While Not TextFileReader.EndOfData
            Try
                CurrentRow = TextFileReader.ReadFields()
                If Not CurrentRow Is Nothing Then
                    ''# Check if DataTable has been created
                    If TextFileTable Is Nothing Then
                        TextFileTable = New DataTable("TextFileTable")
                        ''# Get number of columns
                        UpperBound = CurrentRow.GetUpperBound(0)
                        ''# Create new DataTable
                        For ColumnCount = 0 To UpperBound
                            Column = New DataColumn()
                            Column.DataType = System.Type.GetType("System.String")
                            Column.ColumnName = "Column" & ColumnCount
                            Column.Caption = "Column" & ColumnCount
                            Column.ReadOnly = True
                            Column.Unique = False
                            TextFileTable.Columns.Add(Column)
                        Next
                    End If
                    Row = TextFileTable.NewRow
                    For ColumnCount = 0 To UpperBound
                        If (ColumnCount = 1) Then
                            DoubleTemp = parse_freq_to_flow_rate(Double.Parse(CurrentRow(ColumnCount).ToString))
                            Row("Column" & ColumnCount) = DoubleTemp.ToString("F", CultureInfo.InvariantCulture)
                        Else
                            DateTemp = Date.Parse(CurrentRow(ColumnCount).ToString)

                            Row("Column" & ColumnCount) = DateTemp.ToString("HH:mm:ss")

                        End If
                    Next

                    'If Not (DoubleTemp = 0) Then
                    TextFileTable.Rows.Add(Row)
                    'End If

                End If
            Catch ex As _
            Microsoft.VisualBasic.FileIO.MalformedLineException
                MsgBox("La ligne " & ex.Message &
                "n'est pas valide et va être ignorée.")
            End Try
        End While
        TextFileReader.Dispose()
        chart_debit.Size = New Size(600, 200)
        Me.DataGridView1.DataSource = TextFileTable

        chart_debit.Series(0).ChartType = DataVisualization.Charting.SeriesChartType.Column
        chart_debit.Series(0).Points.Clear()
        chart_debit.ChartAreas("ChartArea1").AxisX.MinorTickMark.Enabled = True
        chart_debit.ChartAreas("ChartArea1").AxisX.Interval = 1
        chart_debit.ChartAreas("ChartArea1").AxisX.IsLabelAutoFit = True
        'cht.ChartAreas("MainChartArea").AxisX.LabelStyle.IsStaggered = True
        chart_debit.ChartAreas("ChartArea1").AxisX.LabelAutoFitStyle = DataVisualization.Charting.LabelAutoFitStyles.DecreaseFont

        chart_debit.Series(0).LegendText = "Débit (L/min)"

        For Count As Integer = 0 To DataGridView1.Rows.Count - 2
            chart_debit.Series(0).Points.AddXY(DataGridView1.Item(0, Count).Value, DataGridView1.Item(1, Count).Value)
        Next

        Me.Panel1.Show()
        Me.Panel2.Show()


    End Sub

    Private Sub Form1_Load(sender As Object, e As EventArgs) Handles Me.Load
        Me.CenterToScreen()
        Me.Panel1.Hide()
        Me.Panel2.Hide()
    End Sub

    Private Function parse_freq_to_flow_rate(ByVal value As Double) As Double
        Dim result As Double = 0

        'equation de la droite y = 1/55 * x
        result = Math.Round((value / 55), 2)

        Return result
    End Function
End Class
