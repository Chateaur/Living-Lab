Imports System.Windows.Forms.DataVisualization.Charting

Public Class Main
    Private db As DataBase

    Private Sub Main_Load(sender As Object, e As EventArgs) Handles Me.Load
        Me.cbx_capt.DropDownStyle = ComboBoxStyle.DropDownList
        Me.panel_data.Hide()
        Me.CenterToScreen()

        Me.date_picker_low.Value = Now.AddDays(-1)
        db = New DataBase()

        If Me.cbx_capt.Items.Count > 0 Then
            Me.cbx_capt.SelectedIndex = 0    ' The first item has index 0 '
        End If
    End Sub

    Private Sub bt_analyse_Click(sender As Object, e As EventArgs) Handles bt_analyse.Click
        Dim data As New DataSet

        If (Me.cbx_capt.SelectedIndex <> -1) Then
            Dim selected_capt As String = Me.cbx_capt.SelectedItem.ToString
            Dim date_low As String = Me.date_picker_low.Value.ToShortDateString + " " + Me.hour_picker_low.Value.ToShortTimeString
            Dim date_high As String = Me.date_picker_high.Value.ToShortDateString + " " + Me.hour_picker_high.Value.ToShortTimeString

            data = db.select_data("SELECT * FROM " + selected_capt + " WHERE date_time BETWEEN STR_TO_DATE('" +
                                  date_low + "','%d/%m/%Y %H:%i') AND STR_TO_DATE('" +
                                  date_high + "','%d/%m/%Y %H:%i');", selected_capt)

            Me.dgv_data.DataSource = data

            dgv_data.DataMember = selected_capt


            For Each row As DataRow In data.Tables(0).Rows
                If row("valeur").ToString = 0 And chk_null_values.Checked Then
                    row.Delete()
                Else

                    row("valeur") = parse_freq_to_flow_rate(Double.Parse(row("valeur")))
                End If
            Next

            Chart_data.Series(0).LegendText = "Débit (L/min)"

            Chart_data.Series(0).XValueMember = "date_time"
            Chart_data.Series(0).YValueMembers = "valeur"

            Chart_data.Series(0).XValueType = ChartValueType.DateTime
            Chart_data.ChartAreas(0).AxisX.LabelStyle.Format = "dd/MM HH:mm:ss"

            Chart_data.ChartAreas(0).CursorX.IsUserSelectionEnabled = True
            Chart_data.ChartAreas(0).CursorX.IntervalType = System.Windows.Forms.DataVisualization.Charting.DateTimeIntervalType.Minutes
            Chart_data.ChartAreas(0).CursorX.Interval = 0.5D

            Chart_data.Series(0).Points.Clear()
            Chart_data.DataSource = Nothing

            Chart_data.DataSource = data
            Me.panel_data.Show()

            Chart_data.Series(0).ToolTip = "Date : #VALX{dd/MM HH:mm:ss} Valeur : #VAL"

            For Each dc As DataGridViewColumn In dgv_data.Columns
                    If (dc.Name = "date_time") Then
                        dc.DefaultCellStyle.Format = "dd/MM/yyyy HH:mm:ss"
                    End If
                Next
            Else
                MsgBox("Merci de saisir une valeur de capteur à analyser.")
        End If
    End Sub

    Private Function parse_freq_to_flow_rate(ByVal value As Double) As Double
        Dim result As Double = 0

        'equation de la droite y = 1/55 * x
        result = Math.Round((value / 55), 2)

        Return result
    End Function

End Class
